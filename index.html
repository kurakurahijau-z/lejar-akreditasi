<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lejar Akreditasi</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    * { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { border: 1px solid rgba(15, 23, 42, .08); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-10">

    <!-- Header -->
    <div class="card bg-white rounded-2xl p-6 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-extrabold tracking-tight">Lejar Akreditasi</h1>
          <p class="text-slate-600 mt-1">
            Track penerimaan waran &amp; perbelanjaan ikut kod waran (Committed ikut status).
          </p>
        </div>

        <div class="flex items-center gap-3">
          <div id="userBadge" class="hidden items-center gap-2">
            <span id="userEmail" class="text-sm text-slate-700"></span>
            <span id="userRole" class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">ADMIN</span>
            <button id="btnLogout" class="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">Logout</button>
          </div>
        </div>
      </div>

      <!-- Login area -->
      <div id="loginArea" class="mt-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="text-slate-700">
            Sila login guna Google (whitelist sahaja boleh masuk).
          </div>
          <div class="flex items-center gap-3">
            <div id="gsiBtn"></div>
          </div>
        </div>
        <div id="loginMsg" class="mt-3 text-sm text-rose-600 hidden"></div>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden mt-8 space-y-8">

      <!-- Summary -->
      <div class="card bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-2xl font-bold">Ringkasan</h2>
          <div class="flex items-center gap-3">
            <div class="text-xs text-slate-500">
              Last sync: <span id="lastSync">-</span>
            </div>
            <button id="btnRefresh" class="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">Refresh</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-5">
          <div class="rounded-2xl border p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Total Penerimaan</div>
            <div id="sumTotalWaran" class="text-2xl font-extrabold mt-1">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">Jumlah semua waran (bukan CLOSED)</div>
          </div>

          <div class="rounded-2xl border p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Total Committed</div>
            <div id="sumCommitted" class="text-2xl font-extrabold mt-1">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">HANTAR PERMOHONAN + SELESAI</div>
          </div>

          <div class="rounded-2xl border p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Total Draft</div>
            <div id="sumDraft" class="text-2xl font-extrabold mt-1">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">KERTAS KERJA + BATAL</div>
          </div>

          <div class="rounded-2xl border p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Total Available</div>
            <div id="sumAvailable" class="text-2xl font-extrabold mt-1">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">TotalWaran - Committed</div>
          </div>
        </div>
      </div>

      <!-- Add Waran -->
      <div id="adminPanel" class="card bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold">Tambah Waran</h2>
            <div class="text-sm text-slate-600 mt-1">
              Waran baru akan muncul sebagai card. Belanja akan direkod dalam card waran tu.
            </div>
          </div>
          <span class="text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold">ADMIN MODE</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-5">
          <input id="inNoWaran" class="border rounded-xl px-3 py-2" placeholder="No Waran (contoh: A1234)" />
          <input id="inTarikhTerima" type="date" class="border rounded-xl px-3 py-2" />
          <input id="inPerihalWaran" class="border rounded-xl px-3 py-2 md:col-span-2" placeholder="Perihal" />
          <div class="flex gap-3">
            <input id="inJumlahWaran" type="number" class="border rounded-xl px-3 py-2 w-full" placeholder="Jumlah (RM)" />
          </div>
        </div>

        <div class="flex items-center justify-between mt-4">
          <div class="flex items-center gap-3">
            <select id="inStatusWaran" class="border rounded-xl px-3 py-2">
              <option value="ACTIVE">ACTIVE</option>
              <option value="CLOSED">CLOSED</option>
            </select>
          </div>
          <button id="btnAddWaran" class="px-5 py-2.5 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
            Tambah Waran
          </button>
        </div>

        <div id="adminMsg" class="mt-3 text-sm text-rose-600 hidden"></div>
      </div>

      <!-- Waran list -->
      <div class="card bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h2 class="text-2xl font-bold">Waran</h2>
          <input id="inSearch" class="border rounded-xl px-3 py-2 w-full md:w-80" placeholder="Cari NoWaran / Perihal..." />
        </div>

        <div id="waranWrap" class="mt-5 space-y-5"></div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG (WAJIB TUKAR)
 *  ========================= */
const CONFIG = {
  CLIENT_ID: "637964120539-99tu5r1qa3k54vqbijvr4jtomj33o20d.apps.googleusercontent.com",
  API_URL: "https://script.google.com/macros/s/AKfycbzMmHAEpCi3v0l473zywDT-2XDucMf6X9-XPya0WVA2rKqGZJbb0vWnfOgWqrOlrY364Q/exec",
};

/** =========================
 *  STATUS RULES
 *  ========================= */
const STATUS = {
  COMMITTED: ["HANTAR PERMOHONAN", "SELESAI"],
  DRAFT: ["KERTAS KERJA", "BATAL"],
};

/** =========================
 *  STATE
 *  ========================= */
const state = {
  loggedIn: false,
  email: "",
  role: "ADMIN",
  sessionToken: "",        // token dari backend (jika backend bagi)
  idToken: "",             // fallback: id_token google
  warans: [],              // list waran
  belanjaByWaranId: {},    // map waranId -> array belanja (INI FIX PENTING)
  lastSync: null,
};

function $(id){ return document.getElementById(id); }

function money(n){
  const v = Number(n || 0);
  return "RM " + v.toLocaleString("ms-MY");
}

function fmtDate(iso){
  if(!iso) return "-";
  // iso boleh jadi "2026-02-16" atau tarikh excel serial (kadang2)
  // kalau number serial, backend patut normalize; tapi kita guard:
  if(typeof iso === "number") return String(iso);
  return String(iso);
}

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function setMsg(el, msg){
  el.textContent = msg || "";
  if(msg) show(el); else hide(el);
}

/** =========================
 *  API HELPERS
 *  ========================= */
async function apiGet(params){
  const url = new URL(CONFIG.API_URL);
  Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method: "GET" });
  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); } catch(e) { data = { ok:false, raw: txt }; }
  if(!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
  return data;
}

async function apiPost(body){
  const res = await fetch(CONFIG.API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body || {})
  });
  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); } catch(e) { data = { ok:false, raw: txt }; }
  if(!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
  return data;
}

function authPayload(){
  // backend kau boleh pilih nak guna sessionToken atau id_token
  return {
    token: state.sessionToken || "",
    id_token: state.idToken || "",
  };
}

/** =========================
 *  LOGIN
 *  ========================= */
function initGoogle(){
  window.google.accounts.id.initialize({
    client_id: CONFIG.CLIENT_ID,
    callback: async (resp) => {
      try{
        setMsg($("loginMsg"), "");
        state.idToken = resp.credential || "";
        // login ke backend (whitelist check kat Apps Script)
        const out = await apiPost({ action: "login", id_token: state.idToken });
        if(!out?.ok) throw new Error(out?.error || "Login gagal");

        state.loggedIn = true;
        state.email = out.email || out.user?.email || "";
        state.role = out.role || "ADMIN";
        state.sessionToken = out.token || out.sessionToken || "";

        afterLoginUI();
        await refreshAll();
      }catch(err){
        console.error(err);
        setMsg($("loginMsg"), "Login gagal: " + (err.message || err));
      }
    }
  });

  window.google.accounts.id.renderButton(
    $("gsiBtn"),
    { theme: "outline", size: "large", shape: "pill" }
  );
}

function afterLoginUI(){
  hide($("loginArea"));
  show($("app"));

  $("userEmail").textContent = state.email || "(unknown)";
  $("userRole").textContent = state.role || "ADMIN";
  $("userBadge").classList.remove("hidden");
  $("userBadge").classList.add("flex");

  // kalau nanti ada user viewer, kau boleh hide admin panel bila role bukan admin
  if((state.role || "").toUpperCase() !== "ADMIN"){
    hide($("adminPanel"));
  }else{
    show($("adminPanel"));
  }
}

function doLogout(){
  // clear state
  state.loggedIn = false;
  state.email = "";
  state.role = "ADMIN";
  state.sessionToken = "";
  state.idToken = "";
  state.warans = [];
  state.belanjaByWaranId = {};
  state.lastSync = null;

  hide($("app"));
  show($("loginArea"));
  $("userBadge").classList.add("hidden");
  $("userBadge").classList.remove("flex");

  // optional: disable auto-select account
  try { window.google.accounts.id.disableAutoSelect(); } catch(e){}
}

/** =========================
 *  LOAD + RENDER
 *  ========================= */
function computeBelanjaMap(belanjaList){
  const map = {};
  (belanjaList || []).forEach(b => {
    const wid = b.WaranID || b.waranId || b.waranID || "";
    if(!wid) return;
    if(!map[wid]) map[wid] = [];
    map[wid].push(b);
  });
  // sort belanja by date (desc) kalau ada
  Object.keys(map).forEach(k => {
    map[k].sort((a,b) => String(b.Tarikh||b.tarikh||"").localeCompare(String(a.Tarikh||a.tarikh||"")));
  });
  return map;
}

function calcTotals(){
  // total penerimaan = sum waran bukan CLOSED
  const waransActive = state.warans.filter(w => (w.StatusWaran || w.statusWaran || "ACTIVE") !== "CLOSED");
  const totalWaran = waransActive.reduce((s,w) => s + Number(w.JumlahWaran || w.jumlahWaran || w.Jumlah || 0), 0);

  // committed/draft = dari belanja ikut status
  let committed = 0;
  let draft = 0;

  Object.entries(state.belanjaByWaranId).forEach(([wid, list]) => {
    (list || []).forEach(b => {
      const amt = Number(b.Amaun || b.amaun || 0);
      const st = String(b.StatusBelanja || b.statusBelanja || "").toUpperCase();
      if(STATUS.COMMITTED.includes(st)) committed += amt;
      if(STATUS.DRAFT.includes(st)) draft += amt;
    });
  });

  const available = totalWaran - committed;

  $("sumTotalWaran").textContent = money(totalWaran);
  $("sumCommitted").textContent = money(committed);
  $("sumDraft").textContent = money(draft);
  $("sumAvailable").textContent = money(available);
}

function waranCard(w){
  const waranId = w.WaranID || w.waranId || "";
  const noWaran = w.NoWaran || w.noWaran || "-";
  const perihal = w.Perihal || w.perihal || "-";
  const tarikh = w.TarikhTerima || w.tarikhTerima || "";
  const jumlah = Number(w.JumlahWaran || w.jumlahWaran || w.Jumlah || 0);
  const statusWaran = String(w.StatusWaran || w.statusWaran || "ACTIVE").toUpperCase();

  const belanjaList = state.belanjaByWaranId[waranId] || [];

  const committed = belanjaList.reduce((s,b) => {
    const st = String(b.StatusBelanja || b.statusBelanja || "").toUpperCase();
    const amt = Number(b.Amaun || b.amaun || 0);
    return s + (STATUS.COMMITTED.includes(st) ? amt : 0);
  }, 0);

  const draft = belanjaList.reduce((s,b) => {
    const st = String(b.StatusBelanja || b.statusBelanja || "").toUpperCase();
    const amt = Number(b.Amaun || b.amaun || 0);
    return s + (STATUS.DRAFT.includes(st) ? amt : 0);
  }, 0);

  const available = jumlah - committed;

  const utilPct = jumlah > 0 ? Math.round((committed / jumlah) * 100) : 0;

  const badge = statusWaran === "CLOSED"
    ? `<span class="text-xs px-3 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-100 font-semibold">CLOSED</span>`
    : `<span class="text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-semibold">ACTIVE</span>`;

  const belanjaRows = belanjaList.length
    ? belanjaList.map(b => {
        const bid = b.BelanjaID || b.belanjaId || "-";
        const bTarikh = fmtDate(b.Tarikh || b.tarikh || "");
        const bPerihal = b.Perihal || b.perihal || "";
        const bCatatan = b.Catatan || b.catatan || "";
        const bAmaun = Number(b.Amaun || b.amaun || 0);
        const bStatus = String(b.StatusBelanja || b.statusBelanja || "").toUpperCase();
        const bNoDok = b.NoDokumen || b.noDokumen || "";
        const bPayee = b.Payee || b.payee || "";

        const pill = STATUS.COMMITTED.includes(bStatus)
          ? `bg-emerald-50 text-emerald-700 border-emerald-100`
          : (bStatus === "KERTAS KERJA" ? `bg-slate-50 text-slate-700 border-slate-100` : `bg-amber-50 text-amber-800 border-amber-100`);

        return `
          <tr class="border-t">
            <td class="py-2 pr-2">
              <div class="mono text-sm">${bid}</div>
              <div class="text-xs text-slate-500">${bTarikh || "-"}</div>
            </td>
            <td class="py-2 pr-2">
              <div class="font-semibold">${escapeHtml(bPerihal)}</div>
              ${bCatatan ? `<div class="text-xs text-slate-500">${escapeHtml(bCatatan)}</div>` : ``}
            </td>
            <td class="py-2 pr-2 font-semibold">${money(bAmaun)}</td>
            <td class="py-2 pr-2">
              <span class="text-xs px-2 py-1 rounded-full border ${pill} font-semibold">${escapeHtml(bStatus || "-")}</span>
            </td>
            <td class="py-2 pr-2">${escapeHtml(bNoDok || "-")}</td>
            <td class="py-2">${escapeHtml(bPayee || "-")}</td>
          </tr>
        `;
      }).join("")
    : `
      <tr class="border-t">
        <td class="py-3 text-slate-500" colspan="6">Belum ada belanja untuk waran ni.</td>
      </tr>
    `;

  // form id unik per waran
  const widSafe = waranId.replace(/[^a-zA-Z0-9_-]/g, "_");

  return `
  <div class="border rounded-2xl p-5 bg-white shadow-sm" data-waran-card="${escapeHtml(waranId)}">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-xl font-extrabold">${escapeHtml(noWaran)} <span class="text-slate-400 font-semibold text-sm">(${escapeHtml(waranId)})</span></div>
        <div class="text-sm text-slate-600 mt-1">
          ${escapeHtml(tarikh)} &nbsp; · &nbsp; <span class="font-semibold">${escapeHtml(perihal)}</span>
        </div>
      </div>
      <div class="flex items-center gap-2">${badge}</div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
      <div class="rounded-2xl border p-4">
        <div class="text-xs text-slate-500 font-semibold">Jumlah Waran</div>
        <div class="text-xl font-extrabold mt-1">${money(jumlah)}</div>
      </div>
      <div class="rounded-2xl border p-4">
        <div class="text-xs text-slate-500 font-semibold">Committed</div>
        <div class="text-xl font-extrabold mt-1">${money(committed)}</div>
      </div>
      <div class="rounded-2xl border p-4">
        <div class="text-xs text-slate-500 font-semibold">Draft</div>
        <div class="text-xl font-extrabold mt-1">${money(draft)}</div>
      </div>
      <div class="rounded-2xl border p-4">
        <div class="text-xs text-slate-500 font-semibold">Available</div>
        <div class="text-xl font-extrabold mt-1">${money(available)}</div>
      </div>
    </div>

    <div class="mt-3">
      <div class="flex items-center justify-between text-xs text-slate-500">
        <div>Utilization (Committed / Jumlah)</div>
        <div>${utilPct}%</div>
      </div>
      <div class="h-2 rounded-full bg-slate-100 mt-2 overflow-hidden">
        <div class="h-full bg-blue-600" style="width:${Math.min(100, Math.max(0, utilPct))}%"></div>
      </div>
    </div>

    <div class="mt-6">
      <div class="flex items-end justify-between gap-4">
        <h3 class="text-lg font-bold">Belanja</h3>
        <div class="text-xs text-slate-500">Committed: HANTAR PERMOHONAN / SELESAI</div>
      </div>

      <div class="mt-3 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-slate-50 text-slate-700">
              <th class="text-left py-2 px-2 w-44">BelanjaID / Tarikh</th>
              <th class="text-left py-2 px-2">Perihal / Catatan</th>
              <th class="text-left py-2 px-2 w-28">Amaun</th>
              <th class="text-left py-2 px-2 w-40">Status</th>
              <th class="text-left py-2 px-2 w-40">No Dokumen</th>
              <th class="text-left py-2 px-2 w-56">Payee</th>
            </tr>
          </thead>
          <tbody>
            ${belanjaRows}
          </tbody>
        </table>
      </div>

      ${ (state.role || "").toUpperCase() === "ADMIN" ? `
      <div class="mt-6 border rounded-2xl p-4 bg-slate-50">
        <div class="flex items-center justify-between">
          <h4 class="font-bold">Tambah Belanja (waran ini)</h4>
          <div class="text-xs text-slate-500">Committed: HANTAR PERMOHONAN / SELESAI</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-4">
          <input id="bPerihal_${widSafe}" class="border rounded-xl px-3 py-2 md:col-span-2" placeholder="Perihal" />
          <input id="bAmaun_${widSafe}" type="number" class="border rounded-xl px-3 py-2" placeholder="Amaun" />
          <select id="bStatus_${widSafe}" class="border rounded-xl px-3 py-2">
            <option value="KERTAS KERJA">KERTAS KERJA</option>
            <option value="HANTAR PERMOHONAN">HANTAR PERMOHONAN</option>
            <option value="SELESAI">SELESAI</option>
            <option value="BATAL">BATAL</option>
          </select>
          <input id="bNoDok_${widSafe}" class="border rounded-xl px-3 py-2" placeholder="No Dokumen" />
          <input id="bPayee_${widSafe}" class="border rounded-xl px-3 py-2 md:col-span-2" placeholder="Payee" />
          <input id="bTarikh_${widSafe}" type="date" class="border rounded-xl px-3 py-2" />
          <input id="bCatatan_${widSafe}" class="border rounded-xl px-3 py-2 md:col-span-2" placeholder="Catatan (optional)" />
        </div>

        <div class="flex items-center justify-between mt-4">
          <div class="text-xs text-slate-500">WaranID: <span class="mono">${escapeHtml(waranId)}</span></div>
          <button data-add-belanja="${escapeHtml(waranId)}"
                  class="px-5 py-2.5 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">
            Tambah Belanja
          </button>
        </div>

        <div id="bMsg_${widSafe}" class="mt-3 text-sm text-rose-600 hidden"></div>
      </div>
      ` : `` }
    </div>
  </div>
  `;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderWaran(){
  const q = ($("inSearch").value || "").toLowerCase().trim();

  const warans = (state.warans || [])
    .slice()
    .sort((a,b) => String(b.TarikhTerima||"").localeCompare(String(a.TarikhTerima||"")));

  const filtered = !q ? warans : warans.filter(w => {
    const no = String(w.NoWaran || "").toLowerCase();
    const p  = String(w.Perihal || "").toLowerCase();
    const id = String(w.WaranID || "").toLowerCase();
    return no.includes(q) || p.includes(q) || id.includes(q);
  });

  $("waranWrap").innerHTML = filtered.map(waranCard).join("");

  // bind add belanja buttons (setiap card)
  document.querySelectorAll("[data-add-belanja]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const waranId = btn.getAttribute("data-add-belanja");
      await handleAddBelanja(waranId);
    });
  });
}

/** =========================
 *  ACTIONS
 *  ========================= */
async function refreshAll(){
  try{
    $("btnRefresh").disabled = true;

    // 1) list waran
    const wOut = await apiGet({ action:"listWaran", ...authPayload() });
    if(!wOut?.ok) throw new Error(wOut?.error || "Gagal load waran");
    state.warans = wOut.data || wOut.warans || [];

    // 2) list belanja
    const bOut = await apiGet({ action:"listBelanja", ...authPayload() });
    if(!bOut?.ok) throw new Error(bOut?.error || "Gagal load belanja");
    const belanjaList = bOut.data || bOut.belanja || [];

    // 3) build map (INI FIX UTAMA)
    state.belanjaByWaranId = computeBelanjaMap(belanjaList);

    state.lastSync = new Date();
    $("lastSync").textContent = state.lastSync.toLocaleString("ms-MY");

    // render
    calcTotals();
    renderWaran();
  }catch(err){
    console.error(err);
    // show at adminMsg kalau ada
    setMsg($("adminMsg"), err.message || String(err));
    setTimeout(()=> setMsg($("adminMsg"), ""), 5000);
  }finally{
    $("btnRefresh").disabled = false;
  }
}

async function handleAddWaran(){
  try{
    setMsg($("adminMsg"), "");
    const noWaran = ($("inNoWaran").value || "").trim();
    const tarikh  = ($("inTarikhTerima").value || "").trim();
    const perihal = ($("inPerihalWaran").value || "").trim();
    const jumlah  = Number(($("inJumlahWaran").value || "0").trim());
    const status  = ($("inStatusWaran").value || "ACTIVE").trim();

    if(!noWaran) throw new Error("No Waran wajib isi");
    if(!tarikh) throw new Error("Tarikh Terima wajib isi");
    if(!perihal) throw new Error("Perihal wajib isi");
    if(!jumlah || jumlah <= 0) throw new Error("Jumlah mesti > 0");

    const out = await apiPost({
      action: "createWaran",
      ...authPayload(),
      body: { noWaran, tarikhTerima: tarikh, perihal, jumlahWaran: jumlah, statusWaran: status }
    });
    if(!out?.ok) throw new Error(out?.error || "Gagal tambah waran");

    // clear form
    $("inNoWaran").value = "";
    $("inTarikhTerima").value = "";
    $("inPerihalWaran").value = "";
    $("inJumlahWaran").value = "";

    await refreshAll();
  }catch(err){
    console.error(err);
    setMsg($("adminMsg"), err.message || String(err));
  }
}

async function handleAddBelanja(waranId){
  const widSafe = waranId.replace(/[^a-zA-Z0-9_-]/g, "_");
  const msgEl = $("bMsg_" + widSafe);
  try{
    setMsg(msgEl, "");

    const perihal = ($("bPerihal_" + widSafe).value || "").trim();
    const amaun   = Number(($("bAmaun_" + widSafe).value || "0").trim());
    const status  = ($("bStatus_" + widSafe).value || "").trim();
    const noDok   = ($("bNoDok_" + widSafe).value || "").trim();
    const payee   = ($("bPayee_" + widSafe).value || "").trim();
    const tarikh  = ($("bTarikh_" + widSafe).value || "").trim();
    const catatan = ($("bCatatan_" + widSafe).value || "").trim();

    if(!perihal) throw new Error("Perihal belanja wajib isi");
    if(!amaun || amaun <= 0) throw new Error("Amaun mesti > 0");
    if(!tarikh) throw new Error("Tarikh belanja wajib isi");

    const out = await apiPost({
      action: "createBelanja",
      ...authPayload(),
      body: { waranId, perihal, amaun, statusBelanja: status, noDokumen: noDok, payee, tarikh, catatan }
    });
    if(!out?.ok) throw new Error(out?.error || "Gagal tambah belanja");

    // clear inputs for that card
    $("bPerihal_" + widSafe).value = "";
    $("bAmaun_" + widSafe).value = "";
    $("bNoDok_" + widSafe).value = "";
    $("bPayee_" + widSafe).value = "";
    $("bTarikh_" + widSafe).value = "";
    $("bCatatan_" + widSafe).value = "";
    $("bStatus_" + widSafe).value = "KERTAS KERJA";

    // QUICK local update (supaya tak “kosong” card lain)
    // kalau backend return created row:
    const created = out.data || out.created || null;
    if(created){
      if(!state.belanjaByWaranId[waranId]) state.belanjaByWaranId[waranId] = [];
      state.belanjaByWaranId[waranId].unshift(created);
      calcTotals();
      renderWaran();
      state.lastSync = new Date();
      $("lastSync").textContent = state.lastSync.toLocaleString("ms-MY");
    }else{
      // fallback refresh full
      await refreshAll();
    }
  }catch(err){
    console.error(err);
    setMsg(msgEl, err.message || String(err));
  }
}

/** =========================
 *  EVENTS
 *  ========================= */
$("btnLogout").addEventListener("click", doLogout);
$("btnRefresh").addEventListener("click", refreshAll);
$("btnAddWaran").addEventListener("click", handleAddWaran);
$("inSearch").addEventListener("input", renderWaran);

/** =========================
 *  INIT
 *  ========================= */
window.addEventListener("load", () => {
  initGoogle();
});
</script>
</body>
</html>
