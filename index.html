<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lejar Akreditasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg1:#f3f6ff;--bg2:#f7fbff;}
    body{background:radial-gradient(1000px 600px at 20% 0%, var(--bg1), transparent),
         radial-gradient(900px 600px at 80% 10%, var(--bg2), transparent),
         #f5f7fb;}
    .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(15,23,42,.08);border:1px solid rgba(148,163,184,.25)}
    .inp{border:1px solid rgba(148,163,184,.35);border-radius:12px;padding:.55rem .75rem;outline:none}
    .inp:focus{border-color:rgba(59,130,246,.65);box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .btn{border-radius:12px;padding:.55rem .9rem;font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:#64748b}
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="card p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-3xl font-extrabold text-slate-900">Lejar Akreditasi</h1>
          <div class="text-slate-600 mt-1">
            Track penerimaan waran & perbelanjaan ikut kod waran (Committed ikut status).
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="userBox" class="text-sm text-slate-600 hidden"></div>
          <button id="logoutBtn" class="btn border bg-white hidden">Logout</button>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card p-6">
      <div class="text-lg font-bold text-slate-900 mb-1">Sila login</div>
      <div class="text-slate-600 text-sm mb-4">Whitelist sahaja boleh masuk. (JSONP – confirm tak kena CORS)</div>

      <div class="grid md:grid-cols-[1fr_auto] gap-3 items-end">
        <div>
          <label class="text-sm font-semibold text-slate-700">Email</label>
          <input id="emailInp" class="inp w-full mt-1" placeholder="contoh: faizan@pms.edu.my">
        </div>
        <button id="loginBtn" class="btn bg-blue-600 text-white">Login</button>
      </div>

      <div id="loginMsg" class="mt-3 text-sm"></div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <!-- Ringkasan -->
      <div class="card p-6 mt-6">
        <div class="flex items-center justify-between gap-3">
          <div class="text-2xl font-extrabold text-slate-900">Ringkasan</div>
          <div class="flex items-center gap-3">
            <div id="lastSync" class="text-xs muted"></div>
            <button id="refreshBtn" class="btn border bg-white">Refresh</button>
          </div>
        </div>

        <div class="grid md:grid-cols-4 gap-4 mt-4" id="summaryGrid"></div>
      </div>

      <!-- Tambah Waran (Admin) -->
      <div id="addWaranCard" class="card p-6 mt-6 hidden">
        <div class="text-2xl font-extrabold text-slate-900">Tambah Waran</div>
        <div class="text-slate-600 text-sm mb-4">Waran baru akan muncul sebagai card. Belanja direkod di dalam card waran tu.</div>

        <div class="grid md:grid-cols-5 gap-3">
          <input id="wNo" class="inp" placeholder="No Waran (contoh: A1234)">
          <input id="wTarikh" class="inp" type="date">
          <input id="wPerihal" class="inp md:col-span-2" placeholder="Perihal">
          <div class="grid grid-cols-2 gap-3">
            <input id="wJumlah" class="inp" placeholder="Jumlah (RM)" inputmode="decimal">
            <select id="wStatus" class="inp">
              <option value="ACTIVE">ACTIVE</option>
              <option value="CLOSED">CLOSED</option>
            </select>
          </div>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button id="addWaranBtn" class="btn bg-blue-600 text-white">Tambah Waran</button>
          <div id="addWaranMsg" class="text-sm muted"></div>
        </div>
      </div>

      <!-- Waran List -->
      <div class="card p-6 mt-6">
        <div class="flex items-center justify-between gap-3">
          <div class="text-2xl font-extrabold text-slate-900">Waran</div>
          <input id="searchInp" class="inp w-full md:w-80" placeholder="Cari NoWaran / Perihal...">
        </div>
        <div id="waranList" class="mt-4 space-y-6"></div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const GAS_URL = "PASTE_URL_EXEC_KAU"; // <--- paste URL /exec kau kat sini

  // ====== STATE ======
  const STATUS_BELANJA = ["KERTAS KERJA","HANTAR PERMOHONAN","SELESAI","BATAL"];
  let session = null;
  let token = localStorage.getItem("LA_TOKEN") || "";
  let cache = null;

  // ====== JSONP API ======
  function b64(obj){
    return btoa(unescape(encodeURIComponent(JSON.stringify(obj||{}))));
  }

  function jsonp(action, params = {}){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const qs = new URLSearchParams({
        action,
        callback: cb,
        ...params
      });

      const url = GAS_URL + (GAS_URL.includes("?") ? "&" : "?") + qs.toString();
      const s = document.createElement("script");
      let done = false;

      window[cb] = (data) => {
        done = true;
        cleanup();
        resolve(data);
      };

      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      s.onerror = () => {
        if (done) return;
        cleanup();
        reject(new Error("JSONP load failed"));
      };

      document.body.appendChild(s);
      s.src = url;
    });
  }

  async function api(action, payload){
    const params = {};
    if (token) params.token = token;
    if (payload) params.payload = b64(payload);
    const res = await jsonp(action, params);
    if (!res || !res.ok){
      const msg = (res && res.error) ? res.error : "Request failed";
      throw new Error(msg);
    }
    return res;
  }

  // ====== UI Helpers ======
  const $ = (id)=>document.getElementById(id);
  const fmtRM = (n)=> "RM " + (Number(n||0).toLocaleString("en-MY",{minimumFractionDigits:0, maximumFractionDigits:2}));
  function badge(text, type="gray"){
    const map = {
      green:"bg-emerald-50 text-emerald-700 border-emerald-200",
      blue:"bg-sky-50 text-sky-700 border-sky-200",
      amber:"bg-amber-50 text-amber-700 border-amber-200",
      red:"bg-rose-50 text-rose-700 border-rose-200",
      gray:"bg-slate-50 text-slate-700 border-slate-200",
    };
    return `<span class="inline-flex items-center px-2.5 py-1 rounded-full border text-xs font-bold ${map[type]||map.gray}">${text}</span>`;
  }

  function statusBadgeBelanja(st){
    st = String(st||"").toUpperCase();
    if (st==="KERTAS KERJA") return badge("KERTAS KERJA","amber");
    if (st==="HANTAR PERMOHONAN") return badge("HANTAR PERMOHONAN","blue");
    if (st==="SELESAI") return badge("SELESAI","green");
    if (st==="BATAL") return badge("BATAL","red");
    return badge(st||"-","gray");
  }

  function statusBadgeWaran(st){
    st = String(st||"").toUpperCase();
    if (st==="ACTIVE") return badge("ACTIVE","green");
    if (st==="CLOSED") return badge("CLOSED","red");
    return badge(st||"-","gray");
  }

  // ====== Render ======
  function renderSummary(r){
    const grid = $("summaryGrid");
    grid.innerHTML = `
      <div class="card p-4">
        <div class="text-xs font-bold text-slate-500">TOTAL PENERIMAAN</div>
        <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmtRM(r.totalPenerimaan)}</div>
        <div class="text-xs muted mt-1">Jumlah semua waran (bukan CLOSED)</div>
      </div>
      <div class="card p-4">
        <div class="text-xs font-bold text-slate-500">TOTAL COMMITTED</div>
        <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmtRM(r.totalCommitted)}</div>
        <div class="text-xs muted mt-1">HANTAR PERMOHONAN + SELESAI</div>
      </div>
      <div class="card p-4">
        <div class="text-xs font-bold text-slate-500">TOTAL DRAFT</div>
        <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmtRM(r.totalDraft)}</div>
        <div class="text-xs muted mt-1">KERTAS KERJA + BATAL</div>
      </div>
      <div class="card p-4">
        <div class="text-xs font-bold text-slate-500">TOTAL AVAILABLE</div>
        <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmtRM(r.totalAvailable)}</div>
        <div class="text-xs muted mt-1">TotalWaran - Committed</div>
      </div>
    `;
  }

  function groupBelanjaByWaranId(belanja){
    const m = {};
    for (const b of (belanja||[])){
      const wid = String(b.WaranID||"").trim();
      if (!wid) continue;
      if (!m[wid]) m[wid] = [];
      m[wid].push(b);
    }
    return m;
  }

  function renderWaranList(data){
    const root = $("waranList");
    const q = $("searchInp").value.trim().toLowerCase();
    const belanjaMap = groupBelanjaByWaranId(data.belanja);

    const list = (data.waran||[])
      .filter(w=>{
        if (!q) return true;
        return String(w.NoWaran||"").toLowerCase().includes(q) || String(w.Perihal||"").toLowerCase().includes(q);
      });

    root.innerHTML = "";
    if (!list.length){
      root.innerHTML = `<div class="text-slate-600">Tak ada data waran.</div>`;
      return;
    }

    for (const w of list){
      const rows = (belanjaMap[w.WaranID] || []);
      const belanjaRows = rows.length
        ? rows.map(x=>`
            <tr class="border-t">
              <td class="py-2 pr-3 mono text-sm">${x.BelanjaID||"-"}</td>
              <td class="py-2 pr-3 mono text-sm">${x.Tarikh||"-"}</td>
              <td class="py-2 pr-3">
                <div class="font-bold text-slate-900">${x.Perihal||"-"}</div>
                <div class="text-xs muted">${x.Catatan||""}</div>
              </td>
              <td class="py-2 pr-3 font-bold">${fmtRM(x.Amaun||0)}</td>
              <td class="py-2 pr-3">
                ${session.role==="ADMIN" ? `
                  <select class="inp text-sm" data-status-edit="${x.BelanjaID}">
                    ${STATUS_BELANJA.map(s=>`
                      <option value="${s}" ${String(x.StatusBelanja||"").toUpperCase()===s ? "selected":""}>${s}</option>
                    `).join("")}
                  </select>
                ` : statusBadgeBelanja(x.StatusBelanja)}
              </td>
              <td class="py-2 pr-3 mono text-sm">${x.NoDokumen||"-"}</td>
              <td class="py-2 pr-3 text-sm">${x.Payee||"-"}</td>
            </tr>
          `).join("")
        : `<tr class="border-t"><td class="py-3 text-slate-500" colspan="7">Belum ada belanja untuk waran ni.</td></tr>`;

      const card = document.createElement("div");
      card.className = "card p-5";

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-extrabold text-slate-900">
              ${w.NoWaran} <span class="text-slate-400 font-bold">(${w.WaranID})</span>
            </div>
            <div class="text-sm text-slate-600 mt-0.5">
              <span class="mono">${w.TarikhTerima||"-"}</span>
              <span class="mx-2">•</span>
              <span class="font-bold">${w.Perihal||"-"}</span>
            </div>
          </div>
          <div class="flex flex-col items-end gap-2">
            ${statusBadgeWaran(w.StatusWaran)}
            ${session.role==="ADMIN" ? `
              <select class="inp text-sm" data-waran-status="${w.WaranID}">
                <option value="ACTIVE" ${String(w.StatusWaran).toUpperCase()==="ACTIVE"?"selected":""}>ACTIVE</option>
                <option value="CLOSED" ${String(w.StatusWaran).toUpperCase()==="CLOSED"?"selected":""}>CLOSED</option>
              </select>
            `:``}
          </div>
        </div>

        <div class="grid md:grid-cols-4 gap-3 mt-4">
          <div class="card p-3">
            <div class="text-xs font-bold text-slate-500">Jumlah Waran</div>
            <div class="text-xl font-extrabold">${fmtRM(w.JumlahWaran)}</div>
          </div>
          <div class="card p-3">
            <div class="text-xs font-bold text-slate-500">Committed</div>
            <div class="text-xl font-extrabold">${fmtRM(w.Committed)}</div>
          </div>
          <div class="card p-3">
            <div class="text-xs font-bold text-slate-500">Draft</div>
            <div class="text-xl font-extrabold">${fmtRM(w.Draft)}</div>
          </div>
          <div class="card p-3">
            <div class="text-xs font-bold text-slate-500">Available</div>
            <div class="text-xl font-extrabold">${fmtRM(w.Available)}</div>
          </div>
        </div>

        <div class="mt-3">
          <div class="text-xs muted mb-1">Utilization (Committed / Jumlah)</div>
          <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-blue-600" style="width:${Math.max(0,Math.min(100,w.UtilizationPct||0))}%"></div>
          </div>
          <div class="text-xs muted mt-1">${w.UtilizationPct||0}%</div>
        </div>

        <div class="mt-5 flex items-center justify-between">
          <div class="text-lg font-extrabold text-slate-900">Belanja</div>
          <div class="text-xs muted">Committed ikut status: HANTAR PERMOHONAN / SELESAI</div>
        </div>

        <div class="mt-2 overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="text-xs text-slate-500">
                <th class="py-2 pr-3">BelanjaID</th>
                <th class="py-2 pr-3">Tarikh</th>
                <th class="py-2 pr-3">Perihal / Catatan</th>
                <th class="py-2 pr-3">Amaun</th>
                <th class="py-2 pr-3">Status</th>
                <th class="py-2 pr-3">No Dokumen</th>
                <th class="py-2 pr-3">Payee</th>
              </tr>
            </thead>
            <tbody>${belanjaRows}</tbody>
          </table>
        </div>

        ${session.role==="ADMIN" ? `
          <div class="card p-4 mt-4">
            <div class="text-base font-extrabold text-slate-900 mb-2">Tambah Belanja (waran ini)</div>
            <div class="grid md:grid-cols-6 gap-3">
              <input class="inp md:col-span-2" placeholder="Perihal" data-add-perihal="${w.NoWaran}">
              <input class="inp" placeholder="Amaun" inputmode="decimal" data-add-amaun="${w.NoWaran}">
              <select class="inp" data-add-status="${w.NoWaran}">
                ${STATUS_BELANJA.map(s=>`<option value="${s}">${s}</option>`).join("")}
              </select>
              <input class="inp" placeholder="No Dokumen" data-add-doc="${w.NoWaran}">
              <input class="inp" placeholder="Payee" data-add-payee="${w.NoWaran}">
              <input class="inp" type="date" data-add-tarikh="${w.NoWaran}">
              <input class="inp md:col-span-5" placeholder="Catatan (optional)" data-add-catatan="${w.NoWaran}">
            </div>
            <div class="mt-3 flex items-center gap-3">
              <button class="btn bg-blue-600 text-white" data-add-btn="${w.NoWaran}">Tambah Belanja</button>
              <div class="text-sm muted" data-add-msg="${w.NoWaran}"></div>
            </div>
          </div>
        ` : ``}
      `;

      root.appendChild(card);

      // listeners
      if (session.role === "ADMIN") {
        // edit belanja status
        card.querySelectorAll("[data-status-edit]").forEach(sel=>{
          sel.addEventListener("change", async ()=>{
            const belanjaId = sel.getAttribute("data-status-edit");
            const newStatus = sel.value;
            sel.disabled = true;
            try{
              await api("updateBelanjaStatus",{BelanjaID: belanjaId, StatusBelanja: newStatus});
              await loadAll();
            }catch(e){
              alert("Update status gagal: " + e.message);
            }finally{
              sel.disabled = false;
            }
          });
        });

        // edit waran status
        const ws = card.querySelector("[data-waran-status]");
        if (ws){
          ws.addEventListener("change", async ()=>{
            ws.disabled = true;
            try{
              await api("updateWaranStatus",{WaranID: ws.getAttribute("data-waran-status"), StatusWaran: ws.value});
              await loadAll();
            }catch(e){
              alert("Update status waran gagal: " + e.message);
            }finally{
              ws.disabled = false;
            }
          });
        }

        // add belanja
        const btn = card.querySelector("[data-add-btn]");
        if (btn){
          btn.addEventListener("click", async ()=>{
            const no = btn.getAttribute("data-add-btn");
            const perihal = card.querySelector(`[data-add-perihal="${no}"]`).value.trim();
            const amaun = card.querySelector(`[data-add-amaun="${no}"]`).value.trim();
            const status = card.querySelector(`[data-add-status="${no}"]`).value;
            const doc = card.querySelector(`[data-add-doc="${no}"]`).value.trim();
            const payee = card.querySelector(`[data-add-payee="${no}"]`).value.trim();
            const tarikh = card.querySelector(`[data-add-tarikh="${no}"]`).value;
            const cat = card.querySelector(`[data-add-catatan="${no}"]`).value.trim();
            const msg = card.querySelector(`[data-add-msg="${no}"]`);

            if (!perihal || !amaun || !tarikh){
              msg.textContent = "Isi Perihal, Amaun & Tarikh dulu.";
              return;
            }

            btn.disabled = true;
            msg.textContent = "Saving...";
            try{
              await api("addBelanja", {
                NoWaran: no,
                Tarikh: tarikh,
                Perihal: perihal,
                Amaun: Number(amaun),
                StatusBelanja: status,
                NoDokumen: doc,
                Payee: payee,
                Catatan: cat
              });
              msg.textContent = "OK ✅";
              await loadAll();
            }catch(e){
              msg.textContent = "Gagal: " + e.message;
            }finally{
              btn.disabled = false;
            }
          });
        }
      }
    }
  }

  // ====== Load / Auth ======
  async function loadAll(){
    const res = await api("getAll");
    cache = res;
    $("lastSync").textContent = "Last sync: " + new Date(res.ringkasan.lastSync).toLocaleString("ms-MY");
    renderSummary(res.ringkasan);
    renderWaranList(res);
  }

  function setLoggedInUI(){
    $("loginCard").classList.add("hidden");
    $("app").classList.remove("hidden");
    $("userBox").classList.remove("hidden");
    $("logoutBtn").classList.remove("hidden");

    $("userBox").innerHTML = `
      <div class="text-right">
        <div class="font-bold text-slate-900">${session.email}</div>
        <div class="text-xs muted">${session.role}</div>
      </div>
    `;

    if (session.role === "ADMIN"){
      $("addWaranCard").classList.remove("hidden");
    } else {
      $("addWaranCard").classList.add("hidden");
    }
  }

  function setLoggedOutUI(){
    $("loginCard").classList.remove("hidden");
    $("app").classList.add("hidden");
    $("userBox").classList.add("hidden");
    $("logoutBtn").classList.add("hidden");
  }

  async function tryMe(){
    if (!token) return false;
    try{
      const res = await api("me");
      session = res.session;
      setLoggedInUI();
      await loadAll();
      return true;
    }catch(e){
      token = "";
      localStorage.removeItem("LA_TOKEN");
      return false;
    }
  }

  // ====== Events ======
  $("loginBtn").addEventListener("click", async ()=>{
    const email = $("emailInp").value.trim().toLowerCase();
    $("loginMsg").textContent = "";
    if (!email){
      $("loginMsg").innerHTML = `<span class="text-rose-600 font-bold">Isi email dulu.</span>`;
      return;
    }
    $("loginBtn").disabled = true;
    $("loginMsg").innerHTML = `<span class="muted">Logging in...</span>`;
    try{
      const res = await jsonp("login", { email, callback: "cb_login_"+Math.random().toString(16).slice(2) });
      if (!res.ok) throw new Error(res.error || "Login failed");
      token = res.token;
      localStorage.setItem("LA_TOKEN", token);
      session = { email: res.email, role: res.role };
      setLoggedInUI();
      await loadAll();
      $("loginMsg").innerHTML = `<span class="text-emerald-700 font-bold">OK ✅</span>`;
    }catch(e){
      $("loginMsg").innerHTML = `<span class="text-rose-600 font-bold">Login gagal: ${e.message}</span>`;
    }finally{
      $("loginBtn").disabled = false;
    }
  });

  $("logoutBtn").addEventListener("click", ()=>{
    token = "";
    session = null;
    cache = null;
    localStorage.removeItem("LA_TOKEN");
    setLoggedOutUI();
  });

  $("refreshBtn").addEventListener("click", async ()=>{
    $("refreshBtn").disabled = true;
    try{ await loadAll(); } finally { $("refreshBtn").disabled = false; }
  });

  $("searchInp").addEventListener("input", ()=>{
    if (cache) renderWaranList(cache);
  });

  $("addWaranBtn").addEventListener("click", async ()=>{
    const NoWaran = $("wNo").value.trim();
    const TarikhTerima = $("wTarikh").value;
    const Perihal = $("wPerihal").value.trim();
    const JumlahWaran = $("wJumlah").value.trim();
    const StatusWaran = $("wStatus").value;
    const msg = $("addWaranMsg");

    msg.textContent = "";
    if (!NoWaran || !TarikhTerima || !Perihal || !JumlahWaran){
      msg.textContent = "Isi No Waran, Tarikh, Perihal, Jumlah dulu.";
      return;
    }

    $("addWaranBtn").disabled = true;
    msg.textContent = "Saving...";
    try{
      await api("addWaran", {
        NoWaran, TarikhTerima, Perihal,
        JumlahWaran: Number(JumlahWaran),
        StatusWaran
      });
      msg.textContent = "OK ✅";
      $("wNo").value = "";
      $("wTarikh").value = "";
      $("wPerihal").value = "";
      $("wJumlah").value = "";
      $("wStatus").value = "ACTIVE";
      await loadAll();
    }catch(e){
      msg.textContent = "Gagal: " + e.message;
    }finally{
      $("addWaranBtn").disabled = false;
    }
  });

  // boot
  (async ()=>{
    setLoggedOutUI();
    await tryMe();
  })();
</script>
</body>
</html>
