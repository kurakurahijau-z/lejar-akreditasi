<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lejar Akreditasi</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    html, body { height: 100%; }
    body { background: #f4f6fb; }
    .card { background:#fff; border:1px solid rgba(15,23,42,.08); border-radius:16px; }
    .shadow-soft { box-shadow: 0 12px 30px rgba(15,23,42,.06); }
    .chip { border:1px solid rgba(15,23,42,.10); border-radius:999px; padding:.20rem .55rem; font-size:.75rem; }
    .table th { font-weight:600; color:#475569; font-size:.75rem; }
    .table td { font-size:.875rem; color:#0f172a; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="min-h-full">
  <div class="max-w-6xl mx-auto p-5 md:p-8">

    <div class="card shadow-soft p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">Lejar Akreditasi</h1>
          <p class="text-slate-600 mt-1">
            Track penerimaan waran & perbelanjaan ikut kod waran (Committed ikut status).
          </p>
        </div>

        <div class="flex items-center gap-3 justify-between md:justify-end">
          <div class="text-right">
            <div class="text-sm text-slate-600" id="userEmail">—</div>
            <div class="text-xs text-slate-500" id="userRole">—</div>
          </div>
          <button id="btnLogout" class="hidden px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 text-slate-700">
            Logout
          </button>
        </div>
      </div>

      <div id="loginBox" class="mt-5">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-3">
          <div class="text-slate-700 text-sm">
            Sila login guna Google (whitelist sahaja boleh masuk).
          </div>
          <div id="gbtn"></div>
        </div>
        <div id="loginMsg" class="mt-3 text-sm text-amber-700 hidden"></div>
      </div>
    </div>

    <div id="app" class="hidden">

      <div class="card shadow-soft p-6 mt-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-bold text-slate-900">Ringkasan</h2>
          <div class="flex items-center gap-2">
            <div class="text-xs text-slate-500" id="lastSync">Last sync: —</div>
            <button id="btnRefresh" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-slate-700 text-sm">
              Refresh
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <div class="card p-4">
            <div class="text-xs text-slate-500 font-semibold">TOTAL PENERIMAAN</div>
            <div class="text-2xl font-extrabold text-slate-900 mt-1" id="sumPenerimaan">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">Jumlah semua waran (bukan CLOSED)</div>
          </div>

          <div class="card p-4">
            <div class="text-xs text-slate-500 font-semibold">TOTAL COMMITTED</div>
            <div class="text-2xl font-extrabold text-slate-900 mt-1" id="sumCommitted">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">HANTAR PERMOHONAN + SELESAI</div>
          </div>

          <div class="card p-4">
            <div class="text-xs text-slate-500 font-semibold">TOTAL DRAFT</div>
            <div class="text-2xl font-extrabold text-slate-900 mt-1" id="sumDraft">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">KERTAS KERJA + BATAL</div>
          </div>

          <div class="card p-4">
            <div class="text-xs text-slate-500 font-semibold">TOTAL AVAILABLE</div>
            <div class="text-2xl font-extrabold text-slate-900 mt-1" id="sumAvailable">RM 0</div>
            <div class="text-xs text-slate-500 mt-1">TotalWaran - Committed</div>
          </div>
        </div>
      </div>

      <div class="card shadow-soft p-6 mt-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold text-slate-900">Tambah Waran</h2>
            <p class="text-sm text-slate-600 mt-1">Waran baru akan muncul sebagai card. Belanja direkod dalam card waran tu.</p>
          </div>
          <span id="adminOnlyBadge" class="hidden chip bg-emerald-50 text-emerald-700">ADMIN MODE</span>
        </div>

        <div id="adminAddWaran" class="mt-4 hidden">
          <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
            <input id="w_no" class="px-4 py-2 rounded-xl border bg-white" placeholder="No Waran (contoh: A1234)" />
            <input id="w_tarikh" type="date" class="px-4 py-2 rounded-xl border bg-white" />
            <input id="w_perihal" class="md:col-span-2 px-4 py-2 rounded-xl border bg-white" placeholder="Perihal" />
            <input id="w_jumlah" type="number" min="0" step="0.01" class="px-4 py-2 rounded-xl border bg-white" placeholder="Jumlah (RM)" />
            <select id="w_status" class="px-4 py-2 rounded-xl border bg-white">
              <option value="ACTIVE">ACTIVE</option>
              <option value="CLOSED">CLOSED</option>
            </select>
          </div>

          <button id="btnAddWaran" class="mt-3 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">
            Tambah Waran
          </button>

          <div id="addWaranMsg" class="mt-2 text-sm text-amber-700 hidden"></div>
        </div>

        <div id="viewerMsg" class="mt-4 hidden text-sm text-slate-600">
          Akaun kau mode <b>VIEWER</b>. Kau boleh tengok sahaja.
        </div>
      </div>

      <div class="card shadow-soft p-6 mt-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h2 class="text-xl font-bold text-slate-900">Waran</h2>
          <input id="q" class="px-4 py-2 rounded-xl border bg-white w-full md:w-80"
                 placeholder="Cari NoWaran / Perihal..." />
        </div>

        <div id="waranList" class="mt-4 space-y-4"></div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      CLIENT_ID: "637964120539-99tu5r1qa3k54vqbijvr4jtomj33o20d.apps.googleusercontent.com",
      BASE_URL: "https://script.google.com/macros/s/AKfycbzMmHAEpCi3v0l473zywDT-2XDucMf6X9-XPya0WVA2rKqGZJbb0vWnfOgWqrOlrY364Q/exec",
      ACTION_LIST_WARAN: "listWaran",
      ACTION_LIST_BELANJA: "listBelanja",
      ACTION_ADD_WARAN: "addWaran",
      ACTION_ADD_BELANJA: "addBelanja",
      ACTION_SET_WARAN_STATUS: "setWaranStatus"
    };

    const state = { token:null, user:null, warans:[], belanjas:[], lastSync:null };

    const $ = (sel) => document.querySelector(sel);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function fmtMoney(n){
      n = Number(n || 0);
      return "RM " + n.toLocaleString("en-MY", { maximumFractionDigits: 2 });
    }
    function fmtDate(d){
      if (!d) return "";
      const s = String(d);
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      return s;
    }
    function upper(s){ return String(s || "").toUpperCase().trim(); }

    function isCommittedStatus(s){
      s = upper(s);
      return s === "HANTAR PERMOHONAN" || s === "SELESAI";
    }
    function isDraftStatus(s){
      s = upper(s);
      return s === "KERTAS KERJA" || s === "BATAL";
    }
    function percent(part, total){
      part = Number(part || 0);
      total = Number(total || 0);
      if (total <= 0) return 0;
      return Math.max(0, Math.min(100, Math.round((part / total) * 100)));
    }
    function getWaranState(w){
      const manual = upper(w.StatusWaran || w.statusWaran || "ACTIVE");
      const available = Number(w.Available ?? w.available ?? 0);
      if (available <= 0) return "CLOSED";
      if (manual === "CLOSED") return "CLOSED";
      return "ACTIVE";
    }

    function computeSummary(warans, belanjas){
      const totalPenerimaan = warans
        .filter(w => upper(w.StatusWaran || w.statusWaran || "ACTIVE") !== "CLOSED")
        .reduce((sum, w) => sum + Number(w.JumlahWaran ?? w.jumlahWaran ?? w.Jumlah ?? 0), 0);

      const totalCommitted = belanjas
        .filter(b => isCommittedStatus(b.StatusBelanja ?? b.statusBelanja ?? b.Status ?? b.status))
        .reduce((sum, b) => sum + Number(b.Amaun ?? b.amaun ?? b.amount ?? 0), 0);

      const totalDraft = belanjas
        .filter(b => isDraftStatus(b.StatusBelanja ?? b.statusBelanja ?? b.Status ?? b.status))
        .reduce((sum, b) => sum + Number(b.Amaun ?? b.amaun ?? b.amount ?? 0), 0);

      const totalAvailable = totalPenerimaan - totalCommitted;
      return { totalPenerimaan, totalCommitted, totalDraft, totalAvailable };
    }

    function setSummaryUI(sum){
      $("#sumPenerimaan").textContent = fmtMoney(sum.totalPenerimaan);
      $("#sumCommitted").textContent  = fmtMoney(sum.totalCommitted);
      $("#sumDraft").textContent      = fmtMoney(sum.totalDraft);
      $("#sumAvailable").textContent  = fmtMoney(sum.totalAvailable);
    }

    // ====== API (FIXED: avoid preflight by using form-urlencoded) ======
    async function apiGet(action, params = {}){
      const url = new URL(CONFIG.BASE_URL);
      url.searchParams.set("action", action);
      if (state.token) url.searchParams.set("token", state.token);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));

      const res = await fetch(url.toString(), { method: "GET" });
      const data = await res.json().catch(()=>null);
      if (!data) throw new Error("Response tidak valid");
      if (data.ok === false) throw new Error(data.error || "API error");
      return data;
    }

    async function apiPost(action, body = {}){
      const form = new URLSearchParams();
      form.set("action", action);
      if (state.token) form.set("token", state.token);

      Object.entries(body).forEach(([k,v]) => {
        if (v === undefined || v === null) return;
        form.set(k, String(v));
      });

      const res = await fetch(CONFIG.BASE_URL, {
        method: "POST",
        body: form
        // ✅ jangan set Content-Type manually (biar browser set sendiri)
        // ✅ ini elak OPTIONS preflight
      });

      const data = await res.json().catch(()=>null);
      if (!data) throw new Error("Response tidak valid");
      if (data.ok === false) throw new Error(data.error || "API error");
      return data;
    }

    // ===== AUTH =====
    function initGoogleButton(){
      google.accounts.id.initialize({
        client_id: CONFIG.CLIENT_ID,
        callback: async (resp) => {
          await handleLogin(resp.credential);
        }
      });
      google.accounts.id.renderButton(
        document.getElementById("gbtn"),
        { theme: "outline", size: "large", text: "signin_with", shape: "pill" }
      );
    }

    async function handleLogin(idToken){
      hide($("#loginMsg"));
      $("#loginMsg").textContent = "";

      try {
        // ✅ login via form-urlencoded (no preflight)
        const data = await apiPost("login", { idToken });

        state.token = data.token;
        state.user = data.user || { email: data.email, role: data.role };

        $("#userEmail").textContent = state.user.email || "-";
        $("#userRole").textContent = (upper(state.user.role) === "ADMIN") ? "ADMIN" : "VIEWER";

        show($("#btnLogout"));
        hide($("#loginBox"));
        show($("#app"));

        if (upper(state.user.role) === "ADMIN") {
          show($("#adminOnlyBadge"));
          show($("#adminAddWaran"));
          hide($("#viewerMsg"));
        } else {
          hide($("#adminOnlyBadge"));
          hide($("#adminAddWaran"));
          show($("#viewerMsg"));
        }

        await refreshAll(true);

      } catch (e) {
        $("#loginMsg").textContent = "Login gagal: " + (e.message || e);
        show($("#loginMsg"));
      }
    }

    function logout(){
      state.token = null;
      state.user = null;
      state.warans = [];
      state.belanjas = [];
      state.lastSync = null;

      $("#userEmail").textContent = "—";
      $("#userRole").textContent = "—";
      hide($("#btnLogout"));
      show($("#loginBox"));
      hide($("#app"));
      $("#waranList").innerHTML = "";
      setSummaryUI({ totalPenerimaan:0, totalCommitted:0, totalDraft:0, totalAvailable:0 });

      try { google.accounts.id.disableAutoSelect(); } catch {}
    }

    // ===== LOAD + RENDER =====
    async function refreshAll(silent=false){
      try {
        if (!silent) $("#btnRefresh").textContent = "Refreshing...";
        const [w, b] = await Promise.all([
          apiGet(CONFIG.ACTION_LIST_WARAN),
          apiGet(CONFIG.ACTION_LIST_BELANJA)
        ]);

        state.warans = w.warans || w.data || w.rows || [];
        state.belanjas = b.belanjas || b.data || b.rows || [];

        state.lastSync = new Date();
        $("#lastSync").textContent = "Last sync: " + state.lastSync.toLocaleString("en-MY");

        const sum = computeSummary(state.warans, state.belanjas);
        setSummaryUI(sum);

        renderWaranList();

      } catch (e) {
        alert("Refresh gagal: " + (e.message || e));
      } finally {
        $("#btnRefresh").textContent = "Refresh";
      }
    }

    function renderWaranList(){
      const q = upper($("#q").value || "");
      const wrap = $("#waranList");
      wrap.innerHTML = "";

      const waransSorted = [...state.warans].sort((a,b)=>{
        const da = String(a.TarikhTerima || a.tarikhTerima || a.Tarikh || "");
        const db = String(b.TarikhTerima || b.tarikhTerima || b.Tarikh || "");
        return db.localeCompare(da);
      });

      const filtered = waransSorted.filter(w=>{
        const no = upper(w.NoWaran || w.noWaran || "");
        const perihal = upper(w.Perihal || w.perihal || "");
        return !q || no.includes(q) || perihal.includes(q);
      });

      if (filtered.length === 0) {
        wrap.innerHTML = `<div class="text-sm text-slate-600">Tiada waran (atau carian tak jumpa).</div>`;
        return;
      }

      filtered.forEach(w=>{
        const waranId = w.WaranID || w.waranId || w.id || "";
        const noWaran = w.NoWaran || w.noWaran || "";
        const tarikh = fmtDate(w.TarikhTerima || w.tarikhTerima || w.Tarikh || "");
        const perihal = w.Perihal || w.perihal || "";

        const belanjas = state.belanjas.filter(b => {
          const bid = b.WaranID || b.waranId || b.waranID || "";
          return String(bid) === String(waranId);
        });

        const jumlah = Number(w.JumlahWaran ?? w.jumlahWaran ?? w.Jumlah ?? 0);
        const committed = belanjas
          .filter(b => isCommittedStatus(b.StatusBelanja ?? b.statusBelanja ?? b.Status ?? b.status))
          .reduce((sum, b) => sum + Number(b.Amaun ?? b.amaun ?? b.amount ?? 0), 0);

        const draft = belanjas
          .filter(b => isDraftStatus(b.StatusBelanja ?? b.statusBelanja ?? b.Status ?? b.status))
          .reduce((sum, b) => sum + Number(b.Amaun ?? b.amaun ?? b.amount ?? 0), 0);

        const available = jumlah - committed;
        const p = percent(committed, jumlah);
        const stateW = getWaranState({ ...w, Available: available });

        const badge = stateW === "CLOSED"
          ? `<span class="chip bg-rose-50 text-rose-700">CLOSED</span>`
          : `<span class="chip bg-emerald-50 text-emerald-700">ACTIVE</span>`;

        const isAdmin = upper(state.user?.role) === "ADMIN";

        const belanjaRows = belanjas.length
          ? belanjas.map(b=>{
              const belanjaId = b.BelanjaID || b.belanjaId || b.id || "";
              const bt = fmtDate(b.Tarikh || b.tarikh || "");
              const bp = b.Perihal || b.perihal || "";
              const bc = b.Catatan || b.catatan || "";
              const amaun = Number(b.Amaun ?? b.amaun ?? 0);
              const st = upper(b.StatusBelanja ?? b.statusBelanja ?? b.Status ?? b.status);
              const doc = b.NoDokumen || b.noDokumen || "";
              const payee = b.Payee || b.payee || "";
              const stChip =
                isCommittedStatus(st)
                  ? `<span class="chip bg-emerald-50 text-emerald-700">${st}</span>`
                  : (isDraftStatus(st)
                      ? `<span class="chip bg-slate-50 text-slate-700">${st}</span>`
                      : `<span class="chip bg-amber-50 text-amber-700">${st}</span>`);

              return `
                <tr class="border-t">
                  <td class="py-3 pr-3 align-top">
                    <div class="mono text-slate-900">${belanjaId}</div>
                    <div class="text-xs text-slate-500 mt-1">${bt || "-"}</div>
                  </td>
                  <td class="py-3 pr-3 align-top">
                    <div class="font-semibold text-slate-900">${bp || "-"}</div>
                    <div class="text-xs text-slate-500 mt-1">${bc || ""}</div>
                  </td>
                  <td class="py-3 pr-3 align-top whitespace-nowrap">${fmtMoney(amaun)}</td>
                  <td class="py-3 pr-3 align-top">${stChip}</td>
                  <td class="py-3 pr-3 align-top">${doc || "-"}</td>
                  <td class="py-3 align-top">${payee || "-"}</td>
                </tr>
              `;
            }).join("")
          : `<tr><td colspan="6" class="py-4 text-sm text-slate-500">Belum ada belanja untuk waran ni.</td></tr>`;

        const addBelanjaForm = isAdmin ? `
          <div class="mt-4 card p-4 bg-slate-50">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-slate-900">Tambah Belanja (waran ini)</div>
              <div class="text-xs text-slate-500">Committed: HANTAR PERMOHONAN / SELESAI</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mt-3">
              <input data-bp="${waranId}" class="px-4 py-2 rounded-xl border bg-white md:col-span-2" placeholder="Perihal" />
              <input data-ba="${waranId}" type="number" min="0" step="0.01" class="px-4 py-2 rounded-xl border bg-white" placeholder="Amaun" />
              <select data-bs="${waranId}" class="px-4 py-2 rounded-xl border bg-white">
                <option value="KERTAS KERJA">KERTAS KERJA</option>
                <option value="HANTAR PERMOHONAN">HANTAR PERMOHONAN</option>
                <option value="SELESAI">SELESAI</option>
                <option value="BATAL">BATAL</option>
              </select>
              <input data-bd="${waranId}" class="px-4 py-2 rounded-xl border bg-white" placeholder="No Dokumen" />
              <input data-by="${waranId}" class="px-4 py-2 rounded-xl border bg-white" placeholder="Payee" />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mt-3">
              <input data-bt="${waranId}" type="date" class="px-4 py-2 rounded-xl border bg-white" />
              <input data-bc="${waranId}" class="px-4 py-2 rounded-xl border bg-white md:col-span-5" placeholder="Catatan (optional)" />
            </div>

            <button data-addbelanja="${waranId}" class="mt-3 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">
              Tambah Belanja
            </button>
            <div data-bmsg="${waranId}" class="mt-2 text-sm text-amber-700 hidden"></div>
          </div>
        ` : "";

        wrap.insertAdjacentHTML("beforeend", `
          <div class="card shadow-soft p-5 border-2 ${stateW === "CLOSED" ? "border-rose-200" : "border-blue-200"}">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <div class="font-extrabold text-slate-900">
                  ${noWaran} <span class="text-slate-500 text-sm">(${waranId})</span>
                </div>
                <div class="text-sm text-slate-600 mt-1">
                  <span class="mono">${tarikh || "-"}</span>
                  <span class="mx-2 text-slate-300">•</span>
                  <span class="font-semibold">${perihal || "-"}</span>
                </div>
              </div>
              <div class="flex items-center gap-2">${badge}</div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
              <div class="card p-3">
                <div class="text-xs text-slate-500 font-semibold">Jumlah Waran</div>
                <div class="text-lg font-extrabold text-slate-900 mt-1">${fmtMoney(jumlah)}</div>
              </div>
              <div class="card p-3">
                <div class="text-xs text-slate-500 font-semibold">Committed</div>
                <div class="text-lg font-extrabold text-slate-900 mt-1">${fmtMoney(committed)}</div>
              </div>
              <div class="card p-3">
                <div class="text-xs text-slate-500 font-semibold">Draft</div>
                <div class="text-lg font-extrabold text-slate-900 mt-1">${fmtMoney(draft)}</div>
              </div>
              <div class="card p-3">
                <div class="text-xs text-slate-500 font-semibold">Available</div>
                <div class="text-lg font-extrabold text-slate-900 mt-1">${fmtMoney(available)}</div>
              </div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
                <span>Utilization (Committed / Jumlah)</span>
                <span class="font-semibold">${p}%</span>
              </div>
              <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                <div class="h-2 bg-blue-600" style="width:${p}%"></div>
              </div>
            </div>

            <div class="mt-5">
              <div class="flex items-center justify-between">
                <div class="text-lg font-bold text-slate-900">Belanja</div>
                <div class="text-xs text-slate-500">Committed: HANTAR PERMOHONAN / SELESAI</div>
              </div>

              <div class="mt-2 overflow-x-auto">
                <table class="w-full table">
                  <thead>
                    <tr class="bg-slate-50">
                      <th class="text-left py-3 pr-3">BelanjaID / Tarikh</th>
                      <th class="text-left py-3 pr-3">Perihal / Catatan</th>
                      <th class="text-left py-3 pr-3">Amaun</th>
                      <th class="text-left py-3 pr-3">Status</th>
                      <th class="text-left py-3 pr-3">No Dokumen</th>
                      <th class="text-left py-3">Payee</th>
                    </tr>
                  </thead>
                  <tbody>${belanjaRows}</tbody>
                </table>
              </div>

              ${addBelanjaForm}
            </div>
          </div>
        `);
      });

      wireActions();
    }

    function wireActions(){
      document.querySelectorAll("[data-addbelanja]").forEach(btn=>{
        btn.onclick = async () => {
          if (upper(state.user?.role) !== "ADMIN") return;
          const waranId = btn.getAttribute("data-addbelanja");

          const perihal = document.querySelector(`[data-bp="${waranId}"]`)?.value?.trim();
          const amaun = Number(document.querySelector(`[data-ba="${waranId}"]`)?.value || 0);
          const status = document.querySelector(`[data-bs="${waranId}"]`)?.value;
          const noDok = document.querySelector(`[data-bd="${waranId}"]`)?.value?.trim();
          const payee = document.querySelector(`[data-by="${waranId}"]`)?.value?.trim();
          const tarikh = document.querySelector(`[data-bt="${waranId}"]`)?.value;
          const catatan = document.querySelector(`[data-bc="${waranId}"]`)?.value?.trim();
          const msg = document.querySelector(`[data-bmsg="${waranId}"]`);

          msg.textContent = "";
          hide(msg);

          if (!perihal) { msg.textContent = "Perihal wajib isi."; show(msg); return; }
          if (!amaun || amaun <= 0) { msg.textContent = "Amaun mesti lebih 0."; show(msg); return; }
          if (!tarikh) { msg.textContent = "Tarikh wajib isi."; show(msg); return; }

          btn.disabled = true;
          btn.textContent = "Saving...";

          try {
            await apiPost(CONFIG.ACTION_ADD_BELANJA, {
              waranId,
              perihal,
              amaun,
              statusBelanja: status,
              tarikh,
              noDokumen: noDok || "",
              payee: payee || "",
              catatan: catatan || ""
            });

            document.querySelector(`[data-bp="${waranId}"]`).value = "";
            document.querySelector(`[data-ba="${waranId}"]`).value = "";
            document.querySelector(`[data-bd="${waranId}"]`).value = "";
            document.querySelector(`[data-by="${waranId}"]`).value = "";
            document.querySelector(`[data-bc="${waranId}"]`).value = "";

            await refreshAll(true);

          } catch (e) {
            msg.textContent = "Gagal tambah belanja: " + (e.message || e);
            show(msg);
          } finally {
            btn.disabled = false;
            btn.textContent = "Tambah Belanja";
          }
        };
      });
    }

    async function addWaran(){
      const msg = $("#addWaranMsg");
      msg.textContent = "";
      hide(msg);

      const noWaran = $("#w_no").value.trim();
      const tarikh = $("#w_tarikh").value;
      const perihal = $("#w_perihal").value.trim();
      const jumlah = Number($("#w_jumlah").value || 0);
      const statusWaran = $("#w_status").value;

      if (!noWaran) { msg.textContent = "No Waran wajib isi."; show(msg); return; }
      if (!tarikh) { msg.textContent = "Tarikh wajib isi."; show(msg); return; }
      if (!perihal) { msg.textContent = "Perihal wajib isi."; show(msg); return; }
      if (!jumlah || jumlah <= 0) { msg.textContent = "Jumlah mesti lebih 0."; show(msg); return; }

      $("#btnAddWaran").disabled = true;
      $("#btnAddWaran").textContent = "Saving...";

      try {
        await apiPost(CONFIG.ACTION_ADD_WARAN, {
          noWaran,
          tarikhTerima: tarikh,
          perihal,
          jumlahWaran: jumlah,
          statusWaran
        });

        $("#w_no").value = "";
        $("#w_tarikh").value = "";
        $("#w_perihal").value = "";
        $("#w_jumlah").value = "";
        $("#w_status").value = "ACTIVE";

        await refreshAll(true);
      } catch (e) {
        msg.textContent = "Gagal tambah waran: " + (e.message || e);
        show(msg);
      } finally {
        $("#btnAddWaran").disabled = false;
        $("#btnAddWaran").textContent = "Tambah Waran";
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      $("#btnLogout").addEventListener("click", logout);
      $("#btnRefresh").addEventListener("click", () => refreshAll(false));
      $("#btnAddWaran").addEventListener("click", addWaran);
      $("#q").addEventListener("input", renderWaranList);

      const t = setInterval(() => {
        if (window.google && google.accounts && google.accounts.id) {
          clearInterval(t);
          initGoogleButton();
        }
      }, 200);
    });
  </script>
</body>
</html>
