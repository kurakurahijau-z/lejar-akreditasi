<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lejar Akreditasi</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { border: 1px solid rgba(15,23,42,0.08); box-shadow: 0 10px 30px rgba(2,6,23,0.06); }
    .pill { border: 1px solid rgba(15,23,42,0.10); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-sky-50">
<div class="max-w-6xl mx-auto px-5 py-10">

  <div class="card rounded-3xl bg-white p-7">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-slate-900">Lejar Akreditasi</h1>
        <p class="text-slate-600 mt-1">Track penerimaan waran & perbelanjaan ikut kod waran (Committed ikut status).</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="meBox" class="hidden text-right">
          <div class="text-sm text-slate-600" id="meEmail"></div>
          <div class="text-xs text-slate-500" id="meRole"></div>
        </div>
        <button id="btnLogout" class="hidden px-4 py-2 rounded-xl pill bg-white hover:bg-slate-50 text-slate-700">Logout</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginPanel" class="card rounded-3xl bg-white p-7 mt-6">
    <h2 class="text-xl font-bold text-slate-900">Sila login guna Google</h2>
    <p class="text-slate-600 text-sm mt-1">Whitelist sahaja boleh masuk.</p>

    <div class="mt-4 flex items-center gap-4">
      <div id="gBtn"></div>
      <div id="loginError" class="text-sm text-red-600 hidden"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="appPanel" class="hidden mt-6 space-y-6">

    <div class="card rounded-3xl bg-white p-7">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-slate-900">Ringkasan</h2>
        <div class="flex items-center gap-3">
          <div class="text-xs text-slate-500">Last sync: <span id="lastSync" class="mono"></span></div>
          <button id="btnRefresh" class="px-4 py-2 rounded-xl pill bg-white hover:bg-slate-50 text-slate-700">Refresh</button>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-4 mt-5">
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500 font-semibold">TOTAL PENERIMAAN</div>
          <div id="sumPenerimaan" class="text-2xl font-extrabold text-slate-900 mt-1">RM 0</div>
          <div class="text-xs text-slate-500 mt-1">Jumlah semua waran (bukan CLOSED)</div>
        </div>
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500 font-semibold">TOTAL COMMITTED</div>
          <div id="sumCommitted" class="text-2xl font-extrabold text-slate-900 mt-1">RM 0</div>
          <div class="text-xs text-slate-500 mt-1">HANTAR PERMOHONAN + SELESAI</div>
        </div>
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500 font-semibold">TOTAL DRAFT</div>
          <div id="sumDraft" class="text-2xl font-extrabold text-slate-900 mt-1">RM 0</div>
          <div class="text-xs text-slate-500 mt-1">KERTAS KERJA + BATAL</div>
        </div>
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500 font-semibold">TOTAL AVAILABLE</div>
          <div id="sumAvailable" class="text-2xl font-extrabold text-slate-900 mt-1">RM 0</div>
          <div class="text-xs text-slate-500 mt-1">TotalWaran − Committed</div>
        </div>
      </div>
    </div>

    <div id="waranFormWrap" class="card rounded-3xl bg-white p-7 hidden">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold text-slate-900">Tambah Waran</h2>
          <p class="text-slate-600 text-sm mt-1">Waran baru akan muncul sebagai card.</p>
        </div>
        <span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-bold">ADMIN MODE</span>
      </div>

      <div class="grid md:grid-cols-6 gap-3 mt-5">
        <input id="w_noWaran" class="px-4 py-3 rounded-xl border border-slate-200" placeholder="No Waran">
        <input id="w_tarikh" type="date" class="px-4 py-3 rounded-xl border border-slate-200">
        <input id="w_perihal" class="md:col-span-2 px-4 py-3 rounded-xl border border-slate-200" placeholder="Perihal">
        <input id="w_jumlah" type="number" step="0.01" class="px-4 py-3 rounded-xl border border-slate-200" placeholder="Jumlah (RM)">
        <select id="w_status" class="px-4 py-3 rounded-xl border border-slate-200">
          <option value="ACTIVE">ACTIVE</option>
          <option value="CLOSED">CLOSED</option>
        </select>
      </div>

      <div class="mt-4 flex items-center gap-3">
        <button id="btnAddWaran" class="px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Tambah Waran</button>
        <div id="waranMsg" class="text-sm text-slate-600"></div>
      </div>
    </div>

    <div class="card rounded-3xl bg-white p-7">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-slate-900">Waran</h2>
        <input id="q" class="px-4 py-2 rounded-xl border border-slate-200" placeholder="Cari NoWaran / Perihal...">
      </div>
      <div id="waranList" class="mt-5 space-y-6"></div>
    </div>

  </div>

</div>

<script>
  // ====== CONFIG (DONE) ======
  const CLIENT_ID = "637964120539-99tu5r1qa3k54vqbijvr4jtomj33o20d.apps.googleusercontent.com";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzMmHAEpCi3v0l473zywDT-2XDucMf6X9-XPya0WVA2rKqGZJbb0vWnfOgWqrOlrY364Q/exec";

  // ====== STATE ======
  let token = localStorage.getItem("lejar_token") || "";
  let me = null, meta = null, data = null;

  // ====== Helpers ======
  const el = (id) => document.getElementById(id);
  const money = (n) => "RM " + (Number(n || 0).toLocaleString("en-MY", { minimumFractionDigits: 0, maximumFractionDigits: 2 }));
  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  function badge(status) {
    const s = String(status || "").toUpperCase();
    if (s === "ACTIVE") return `<span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-bold">ACTIVE</span>`;
    if (s === "CLOSED") return `<span class="px-3 py-1 rounded-full bg-rose-50 text-rose-700 text-xs font-bold">CLOSED</span>`;
    return `<span class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 text-xs font-bold">${escapeHtml(status)}</span>`;
  }

  function showLoginErr(msg){
    el("loginError").textContent = "Login gagal: " + msg;
    el("loginError").classList.remove("hidden");
  }
  function showLogin(){
    el("loginPanel").classList.remove("hidden");
    el("appPanel").classList.add("hidden");
    el("btnLogout").classList.add("hidden");
    el("meBox").classList.add("hidden");
  }
  function showApp(){
    el("loginPanel").classList.add("hidden");
    el("appPanel").classList.remove("hidden");
    el("btnLogout").classList.remove("hidden");
    el("meBox").classList.remove("hidden");
  }

  async function api(action, body){
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ action, ...body })
    });
    const json = await res.json();
    return json;
  }

  // ====== Google Sign-In init ======
  window.onload = () => {
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: async (resp) => {
        try {
          el("loginError").classList.add("hidden");
          const idToken = resp.credential;

          const out = await api("loginGoogle", { idToken });
          if (!out.ok) return showLoginErr(out.error || "Unauthorized");

          token = out.data.token;
          localStorage.setItem("lejar_token", token);
          await loadAll();
        } catch (e) {
          showLoginErr(e.message || String(e));
        }
      }
    });

    google.accounts.id.renderButton(el("gBtn"), {
      theme: "outline",
      size: "large",
      shape: "pill",
      text: "continue_with"
    });

    if (token) loadAll();
    else showLogin();
  };

  // ====== App ======
  async function loadAll(){
    const out = await api("getAll", { token });
    if (!out.ok){
      localStorage.removeItem("lejar_token");
      token = "";
      showLoginErr(out.error || "Session expired");
      return showLogin();
    }

    data = out.data;
    me = data.me;
    meta = data.meta;

    el("meEmail").textContent = me.email;
    el("meRole").textContent = me.role;

    if (String(me.role).toUpperCase() === "ADMIN") el("waranFormWrap").classList.remove("hidden");
    else el("waranFormWrap").classList.add("hidden");

    el("lastSync").textContent = data.lastSync;
    el("sumPenerimaan").textContent = money(data.summary.totalPenerimaan);
    el("sumCommitted").textContent = money(data.summary.totalCommitted);
    el("sumDraft").textContent = money(data.summary.totalDraft);
    el("sumAvailable").textContent = money(data.summary.totalAvailable);

    renderWaran();
    showApp();
  }

  function renderWaran(){
    const q = el("q").value.trim().toLowerCase();
    const list = (data?.waran || []).filter(w => !q || String(w.NoWaran).toLowerCase().includes(q) || String(w.Perihal).toLowerCase().includes(q));

    el("waranList").innerHTML = list.map(w => {
      const s = w.stats || {};
      const util = Number(s.utilization || 0);

      const belanjaRows = (w.belanja || []).map(b => {
        const options = meta.statusBelanja.map(st => `<option value="${escapeHtml(st)}" ${st===b.StatusBelanja?"selected":""}>${escapeHtml(st)}</option>`).join("");
        return `
          <tr class="border-t border-slate-100">
            <td class="py-2 pr-3 align-top mono text-xs text-slate-700">${escapeHtml(b.BelanjaID)}<div class="text-slate-400">${escapeHtml(b.Tarikh)}</div></td>
            <td class="py-2 pr-3 align-top text-sm font-semibold text-slate-900">${escapeHtml(b.Perihal)}<div class="text-xs text-slate-500">${escapeHtml(b.Catatan || "")}</div></td>
            <td class="py-2 pr-3 align-top text-sm text-slate-900">${money(b.Amaun)}</td>
            <td class="py-2 pr-3 align-top">
              <div class="flex items-center gap-2">
                <select data-bid="${escapeHtml(b.BelanjaID)}" class="statusSel px-3 py-2 rounded-xl border border-slate-200 text-sm">${options}</select>
                <button data-bid="${escapeHtml(b.BelanjaID)}" class="btnUpdateStatus px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Update</button>
              </div>
            </td>
            <td class="py-2 pr-3 align-top text-sm text-slate-700 mono">${escapeHtml(b.NoDokumen || "")}</td>
            <td class="py-2 pr-3 align-top text-sm text-slate-700">${escapeHtml(b.Payee || "")}</td>
          </tr>
        `;
      }).join("");

      const belanjaTable = (w.belanja || []).length
        ? `<table class="w-full mt-3">
            <thead><tr class="text-left text-xs text-slate-500">
              <th class="py-2 pr-3">BelanjaID / Tarikh</th><th class="py-2 pr-3">Perihal / Catatan</th><th class="py-2 pr-3">Amaun</th>
              <th class="py-2 pr-3">Status (edit)</th><th class="py-2 pr-3">No Dokumen</th><th class="py-2 pr-3">Payee</th>
            </tr></thead>
            <tbody>${belanjaRows}</tbody>
           </table>`
        : `<div class="text-sm text-slate-500 mt-3">Belum ada belanja untuk waran ni.</div>`;

      const addForm = (String(me.role).toUpperCase()==="ADMIN") ? `
        <div class="mt-5 rounded-2xl border border-slate-200 p-4 bg-slate-50/40">
          <div class="font-bold text-slate-900">Tambah Belanja (waran ini)</div>
          <div class="grid md:grid-cols-6 gap-3 mt-3">
            <input class="b_perihal md:col-span-2 px-4 py-3 rounded-xl border border-slate-200" placeholder="Perihal">
            <input class="b_amaun px-4 py-3 rounded-xl border border-slate-200" type="number" step="0.01" placeholder="Amaun">
            <select class="b_status px-4 py-3 rounded-xl border border-slate-200">
              ${meta.statusBelanja.map(st => `<option value="${escapeHtml(st)}">${escapeHtml(st)}</option>`).join("")}
            </select>
            <input class="b_dok px-4 py-3 rounded-xl border border-slate-200" placeholder="No Dokumen">
            <input class="b_payee px-4 py-3 rounded-xl border border-slate-200" placeholder="Payee">
          </div>
          <div class="grid md:grid-cols-6 gap-3 mt-3">
            <input class="b_tarikh px-4 py-3 rounded-xl border border-slate-200" type="date">
            <input class="b_catatan md:col-span-5 px-4 py-3 rounded-xl border border-slate-200" placeholder="Catatan (optional)">
          </div>
          <div class="mt-3">
            <button data-wid="${escapeHtml(w.WaranID)}" data-nw="${escapeHtml(w.NoWaran)}"
              class="btnAddBelanja px-5 py-3 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">
              Tambah Belanja
            </button>
          </div>
        </div>
      ` : "";

      return `
        <div class="rounded-3xl border border-slate-200 p-5">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-extrabold text-slate-900">${escapeHtml(w.NoWaran)} <span class="text-slate-400 font-semibold text-sm">(${escapeHtml(w.WaranID)})</span></div>
              <div class="text-sm text-slate-600 mt-1">${escapeHtml(w.TarikhTerima)} · <span class="font-semibold">${escapeHtml(w.Perihal)}</span></div>
            </div>
            ${badge(w.StatusWaran)}
          </div>

          <div class="grid md:grid-cols-4 gap-3 mt-4">
            <div class="rounded-2xl border border-slate-200 p-4"><div class="text-xs text-slate-500 font-semibold">Jumlah Waran</div><div class="text-xl font-extrabold mt-1">${money(s.jumlah)}</div></div>
            <div class="rounded-2xl border border-slate-200 p-4"><div class="text-xs text-slate-500 font-semibold">Committed</div><div class="text-xl font-extrabold mt-1">${money(s.committed)}</div></div>
            <div class="rounded-2xl border border-slate-200 p-4"><div class="text-xs text-slate-500 font-semibold">Draft</div><div class="text-xl font-extrabold mt-1">${money(s.draft)}</div></div>
            <div class="rounded-2xl border border-slate-200 p-4"><div class="text-xs text-slate-500 font-semibold">Available</div><div class="text-xl font-extrabold mt-1">${money(s.available)}</div></div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between text-xs text-slate-500"><div>Utilization</div><div>${util}%</div></div>
            <div class="h-2 rounded-full bg-slate-100 mt-2 overflow-hidden"><div class="h-2 bg-sky-500" style="width:${util}%;"></div></div>
          </div>

          <div class="mt-5">
            <div class="text-xl font-bold text-slate-900">Belanja</div>
            ${belanjaTable}
            ${addForm}
          </div>
        </div>
      `;
    }).join("");

    wireButtons();
  }

  function wireButtons(){
    document.querySelectorAll(".btnAddBelanja").forEach(btn=>{
      btn.onclick = async ()=>{
        const wrap = btn.closest(".rounded-3xl");
        const waranId = btn.getAttribute("data-wid");
        const noWaran = btn.getAttribute("data-nw");

        const perihal = wrap.querySelector(".b_perihal").value.trim();
        const amaun = wrap.querySelector(".b_amaun").value.trim();
        const statusBelanja = wrap.querySelector(".b_status").value.trim();
        const noDokumen = wrap.querySelector(".b_dok").value.trim();
        const payee = wrap.querySelector(".b_payee").value.trim();
        const tarikh = wrap.querySelector(".b_tarikh").value.trim();
        const catatan = wrap.querySelector(".b_catatan").value.trim();

        if (!perihal || !amaun || !tarikh) return alert("Isi Perihal, Amaun, dan Tarikh.");

        const out = await api("addBelanja", { token, payload: { waranId, noWaran, perihal, amaun, statusBelanja, noDokumen, payee, tarikh, catatan }});
        if (!out.ok) return alert("Gagal tambah belanja: " + (out.error||"unknown"));

        await loadAll();
      };
    });

    document.querySelectorAll(".btnUpdateStatus").forEach(btn=>{
      btn.onclick = async ()=>{
        const belanjaId = btn.getAttribute("data-bid");
        const sel = document.querySelector(`select.statusSel[data-bid="${belanjaId}"]`);
        const statusBelanja = sel.value;

        const out = await api("updateBelanjaStatus", { token, payload: { belanjaId, statusBelanja }});
        if (!out.ok) return alert("Gagal update status: " + (out.error||"unknown"));

        await loadAll();
      };
    });
  }

  async function addWaran(){
    el("waranMsg").textContent = "";
    const noWaran = el("w_noWaran").value.trim();
    const tarikhTerima = el("w_tarikh").value.trim();
    const perihal = el("w_perihal").value.trim();
    const jumlahWaran = el("w_jumlah").value.trim();
    const statusWaran = el("w_status").value.trim();
    if(!noWaran||!tarikhTerima||!perihal||!jumlahWaran){ el("waranMsg").textContent="Isi semua field dulu."; return; }

    const out = await api("addWaran", { token, payload: { noWaran, tarikhTerima, perihal, jumlahWaran, statusWaran }});
    if(!out.ok){ el("waranMsg").textContent="Gagal: "+(out.error||"unknown"); return; }

    el("w_noWaran").value=""; el("w_perihal").value=""; el("w_jumlah").value=""; el("w_status").value="ACTIVE";
    el("waranMsg").textContent="Waran ditambah.";
    await loadAll();
  }

  function logout(){
    token = "";
    localStorage.removeItem("lejar_token");
    showLogin();
  }

  el("btnLogout").onclick = logout;
  el("btnRefresh").onclick = () => loadAll();
  el("btnAddWaran").onclick = addWaran;
  el("q").oninput = () => renderWaran();
</script>
</body>
</html>
